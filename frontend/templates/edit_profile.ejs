<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Profile | Elegance Perfumery</title>
  <link rel="stylesheet" href="../static/Styles/edit_profile.css">
  <link rel="stylesheet" href="/static/Styles/navbar.css">
  <link rel="stylesheet" href="/static/Styles/footer.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <!-- Include the navbar partial -->
  <%- include('partials/navbar', {user, currentPage}) %>

  <!-- Scroll Progress Indicator -->
  <div class="scroll-progress" id="scrollProgress"></div>

  <!-- Back to Top Button -->
  <button class="back-to-top" id="backToTop">
    <i class="fas fa-chevron-up"></i>
  </button>

  <!-- Hero Section -->
  <header class="edit-hero">
    <div class="hero-overlay"></div>
    <div class="hero-content">
      <h1><i class="fas fa-user-edit"></i> Edit Your Profile</h1>
      <p>Update your personal information and preferences to personalize your experience</p>
    </div>
  </header>

  <!-- Edit Profile Form -->
  <div class="edit-profile-container">
    <div class="edit-profile-card">
      <form id="editProfileForm" class="edit-profile-form" enctype="multipart/form-data">
        <!-- Profile Picture Section -->
        <div class="form-section">
          <div class="section-header">
            <h2><i class="fas fa-camera"></i> Profile Picture</h2>
          </div>
          <div class="profile-picture-section">
            <div class="profile-picture-preview-area">
              <img id="currentProfilePic" src="images/default_profile.png" alt="Profile Picture">
              <img id="newProfilePicPreview" src="" alt="New Profile Picture" class="d-none">
              <i id="defaultProfileIcon" class="fas fa-user-circle d-block"></i>
              <div class="upload-overlay">
                <i class="fas fa-camera"></i>
                <span>Click to upload</span>
              </div>
            </div>
            <input type="file" id="profile_image" name="profile_image" accept="image/*" class="d-none">
            <input type="hidden" id="remove_profile_image" name="remove_profile_image" value="0">
            <div class="profile-picture-actions">
              <button type="button" id="changePictureBtn" class="btn btn-secondary">
                <i class="fas fa-upload"></i> Change Picture
              </button>
              <button type="button" id="removePictureBtn" class="btn btn-danger d-none">
                <i class="fas fa-trash"></i> Remove Picture
              </button>
            </div>
          </div>
        </div>

        <!-- Personal Information Section -->
        <div class="form-section">
          <div class="section-header">
            <h2><i class="fas fa-user"></i> Personal Information</h2>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="username"><i class="fas fa-user-tag"></i> Username</label>
              <input type="text" id="username" name="username" value="<%= user ? user.name : '' %>" required>
            </div>
            <div class="form-group">
              <label for="email"><i class="fas fa-envelope"></i> Email</label>
              <input type="email" id="email" name="email" value="<%= user ? user.email : '' %>" required>
            </div>
            <div class="form-group">
              <label for="address"><i class="fas fa-map-marker-alt"></i> Address</label>
              <input type="text" id="address" name="address" value="<%= user && user.address ? user.address : '' %>" placeholder="Enter your address">
            </div>
            <div class="form-group">
              <label for="phone"><i class="fas fa-phone"></i> Phone</label>
              <input type="text" id="phone" name="phone" value="<%= user && user.phone ? user.phone : '' %>" placeholder="Enter your phone number">
            </div>
          </div>
        </div>

        <!-- Design Preferences Section -->
        <div class="form-section">
          <div class="section-header">
            <h2><i class="fas fa-palette"></i> Design Preferences</h2>
          </div>
          <div class="form-group">
            <label for="design_style"><i class="fas fa-paint-brush"></i> Preferred Design Style</label>
            <select id="design_style" name="design_style">
              <option value="">Select your preferred design style</option>
              <option value="Modern">Modern</option>
              <option value="Minimalist">Minimalist</option>
              <option value="Bohemian">Bohemian</option>
              <option value="Industrial">Industrial</option>
              <option value="Mid-Century Modern">Mid-Century Modern</option>
              <option value="Traditional">Traditional</option>
              <option value="Farmhouse">Farmhouse</option>
              <option value="Coastal">Coastal</option>
              <option value="Scandinavian">Scandinavian</option>
            </select>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <a href="/profile" class="btn btn-outline">
            <i class="fas fa-arrow-left"></i> Cancel
          </a>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-container">
      <div class="footer-brand">
        <a href="/" class="footer-logo">
          <span class="footer-logo-title">Elegance</span>
          <span class="footer-logo-subtitle">Perfumery</span>
        </a>
        <p class="footer-description">
          Curating timeless fragrances crafted with the finest ingredients for truly memorable experiences.
        </p>
      </div>

      <nav class="footer-nav">
        <a href="/">Home</a>
        <a href="/about">About</a>
        <a href="/contact">Contact</a>
        <a href="/product">Collection</a>
      </nav>

      <div class="footer-contact">
        <h3>Contact</h3>
        <p>Email: <a href="mailto:contact@elegance-perfumery.in">contact@elegance-perfumery.in</a></p>
        <p>Phone: <a href="tel:+912226404465">+91 22 2640 4465</a></p>
        <p>Mon - Sat: 10:00 AM - 8:00 PM</p>
      </div>
    </div>

    <div class="footer-bottom">
      <p>Â© <span data-current-year></span> Elegance Perfumery. All rights reserved.</p>
      <p class="footer-made-by">Crafted with care in Mumbai, India.</p>
    </div>
  </footer>

  <script>
    // Set current year in footer
    document.querySelector('[data-current-year]').textContent = new Date().getFullYear();

    // Populate design style if available
    const designStyle = "<%= user && user.design_style ? user.design_style : '' %>";
    if (designStyle) {
      document.getElementById('design_style').value = designStyle;
    }

    // Handle profile picture display
    const currentPic = document.getElementById('currentProfilePic');
    const defaultIcon = document.getElementById('defaultProfileIcon');
    const removeBtn = document.getElementById('removePictureBtn');

    // Check if user has profile image or OAuth avatar
    const profileImage = "<%= user && user.profile_image ? user.profile_image : '' %>";
    const avatarUrl = "<%= user && user.avatar_url ? user.avatar_url : '' %>";
    
    if (profileImage) {
      currentPic.src = `/uploads/${profileImage}`;
      currentPic.classList.remove('d-none');
      defaultIcon.classList.add('d-none');
      removeBtn.classList.remove('d-none');
    } else if (avatarUrl) {
      currentPic.src = avatarUrl;
      currentPic.classList.remove('d-none');
      defaultIcon.classList.add('d-none');
    }

    // Scroll progress
    const scrollProgress = document.getElementById('scrollProgress');
    window.addEventListener('scroll', () => {
      const scrollTop = window.pageYOffset;
      const docHeight = document.body.offsetHeight - window.innerHeight;
      const scrollPercent = (scrollTop / docHeight) * 100;
      scrollProgress.style.width = scrollPercent + '%';
    });

    // Back to top button
    const backToTop = document.getElementById('backToTop');
    window.addEventListener('scroll', () => {
      if (window.pageYOffset > 300) {
        backToTop.classList.add('visible');
      } else {
        backToTop.classList.remove('visible');
      }
    });
    backToTop.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Animate form sections on scroll
    const observerOptions = { threshold: 0.1, rootMargin: '0px 0px -50px 0px' };
    const observer = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) entry.target.classList.add('animate');
      });
    }, observerOptions);
    document.querySelectorAll('.form-section').forEach((section, index) => {
      setTimeout(() => observer.observe(section), index * 200);
    });

    // Profile picture change & remove
    document.getElementById('changePictureBtn').addEventListener('click', () => {
      document.getElementById('profile_image').click();
    });
    document.getElementById('profile_image').addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          document.getElementById('newProfilePicPreview').src = reader.result;
          document.getElementById('newProfilePicPreview').classList.remove('d-none');
          currentPic.classList.add('d-none');
          defaultIcon.classList.add('d-none');
        };
        reader.readAsDataURL(file);
      }
    });
    document.getElementById('removePictureBtn').addEventListener('click', () => {
      currentPic.src = 'images/default_profile.png';
      currentPic.classList.remove('d-none');
      document.getElementById('newProfilePicPreview').classList.add('d-none');
      defaultIcon.classList.remove('d-none');
      document.getElementById('remove_profile_image').value = 1;
      removeBtn.classList.add('d-none');
    });

    // Form submission
    document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      
      try {
        const response = await fetch('/update-profile', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('Profile updated successfully!');
          window.location.href = '/profile';
        } else {
          alert(result.error || 'Failed to update profile');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while updating your profile');
      }
    });
    
    // Mobile menu toggle
    function toggleMenu() {
      const nav = document.getElementById('primaryNav');
      nav.classList.toggle('active');
    }
  </script>
</body>
</html>